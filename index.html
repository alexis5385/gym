<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Gimnasio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .status-activo { background-color: #d1fae5; color: #065f46; }
        .status-proximo-vencer { background-color: #fef3c7; color: #92400e; }
        .status-vencido { background-color: #fee2e2; color: #991b1b; }

        .custom-alert-overlay, .edit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem; /* Added padding for smaller screens */
        }
        .custom-alert-box, .edit-modal-box {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 90%; /* Ensure modal fits on small screens */
            width: auto; /* Adjust width based on content */
        }
        .custom-alert-box button, .edit-modal-box button {
            margin-top: 15px;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        .custom-alert-confirm, .edit-modal-save {
            background-color: #2563eb; /* Blue for save/confirm */
            color: white;
            margin-right: 10px;
        }
        .custom-alert-cancel, .edit-modal-cancel {
            background-color: #6b7280; /* Gray for cancel */
            color: white;
        }
        .edit-modal-box label {
            display: block;
            text-align: left;
            margin-top: 10px;
            font-weight: 500;
        }
        .edit-modal-box input, .edit-modal-box select {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 6px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="container mx-auto max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-600">Gestión de Membresías del Gimnasio</h1>
        </header>

        <section id="registration-form-section" class="mb-10 p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-6 text-sky-700">Registrar Nuevo Miembro</h2>
            <form id="member-form" class="space-y-4">
                <div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700">Nombre Completo:</label>
                    <input type="text" id="fullName" name="fullName" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                </div>
                <div>
                    <label for="registrationDate" class="block text-sm font-medium text-gray-700">Fecha de Inscripción/Inicio:</label>
                    <input type="date" id="registrationDate" name="registrationDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                </div>
                <div>
                    <label for="membershipType" class="block text-sm font-medium text-gray-700">Tipo de Membresía:</label>
                    <select id="membershipType" name="membershipType" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="Mensual">Mensual</option>
                        <option value="Trimestral">Trimestral</option>
                        <option value="Anual">Anual</option>
                    </select>
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico:</label>
                    <input type="email" id="email" name="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Número de Teléfono:</label>
                    <input type="tel" id="phone" name="phone" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                </div>
                <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition duration-150 ease-in-out">
                    Registrar Miembro
                </button>
            </form>
        </section>

        <section id="member-list-section" class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-sky-700">Miembros Registrados</h2>
            <div class="mb-4">
                <label for="searchMember" class="block text-sm font-medium text-gray-700">Buscar Miembro por Nombre:</label>
                <input type="text" id="searchMember" placeholder="Escribe un nombre..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
            </div>
            <div class="overflow-x-auto">
                <table id="membersTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Último Pago/Inicio</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Membresía</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimiento</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Próximo Pago</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <p id="no-members-message" class="text-center text-gray-500 py-4 hidden">No hay miembros registrados.</p>
        </section>
    </div>

    <div id="customAlertContainer"></div>

    <div id="editMemberModal" class="edit-modal-overlay hidden">
        <div class="edit-modal-box">
            <h3 class="text-xl font-semibold mb-4">Editar Miembro</h3>
            <form id="edit-form" class="space-y-3">
                <input type="hidden" id="editMemberId">
                <div>
                    <label for="editFullName">Nombre Completo:</label>
                    <input type="text" id="editFullName" required>
                </div>
                <div>
                    <label for="editLastPaymentDate">Fecha de Último Pago/Inicio:</label>
                    <input type="date" id="editLastPaymentDate" required>
                </div>
                <div>
                    <label for="editMembershipType">Tipo de Membresía:</label>
                    <select id="editMembershipType" required>
                        <option value="Mensual">Mensual</option>
                        <option value="Trimestral">Trimestral</option>
                        <option value="Anual">Anual</option>
                    </select>
                </div>
                <div>
                    <label for="editEmail">Correo Electrónico:</label>
                    <input type="email" id="editEmail" required>
                </div>
                <div>
                    <label for="editPhone">Número de Teléfono:</label>
                    <input type="tel" id="editPhone" required>
                </div>
                <div class="flex justify-end space-x-3 pt-3">
                    <button type="button" id="cancelEdit" class="edit-modal-cancel">Cancelar</button>
                    <button type="submit" class="edit-modal-save">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const memberForm = document.getElementById('member-form');
            const membersTableBody = document.getElementById('membersTableBody');
            const searchMemberInput = document.getElementById('searchMember');
            const registrationDateInput = document.getElementById('registrationDate');
            const noMembersMessage = document.getElementById('no-members-message');
            const membersTable = document.getElementById('membersTable');

            // Modal de edición
            const editMemberModal = document.getElementById('editMemberModal');
            const editForm = document.getElementById('edit-form');
            const cancelEditButton = document.getElementById('cancelEdit');
            let editingMemberId = null; // Para rastrear el ID del miembro que se está editando

            const today = new Date().toISOString().split('T')[0];
            if (registrationDateInput) {
                registrationDateInput.value = today;
            }

            let members = JSON.parse(localStorage.getItem('gymMembers')) || [];

            function showCustomAlert(message, type = 'info', onConfirm) {
                const alertContainer = document.getElementById('customAlertContainer');
                alertContainer.innerHTML = ''; 

                const overlay = document.createElement('div');
                overlay.className = 'custom-alert-overlay';

                const alertBox = document.createElement('div');
                alertBox.className = 'custom-alert-box';

                const messageP = document.createElement('p');
                messageP.textContent = message;
                alertBox.appendChild(messageP);

                if (type === 'confirm') {
                    const confirmButton = document.createElement('button');
                    confirmButton.textContent = 'Confirmar';
                    confirmButton.className = 'bg-red-600 text-white'; // Red for delete confirmation
                    confirmButton.onclick = () => {
                        if (onConfirm) onConfirm();
                        overlay.remove();
                    };
                    alertBox.appendChild(confirmButton);

                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancelar';
                    cancelButton.className = 'custom-alert-cancel';
                    cancelButton.onclick = () => overlay.remove();
                    alertBox.appendChild(cancelButton);
                } else { 
                    const okButton = document.createElement('button');
                    okButton.textContent = 'OK';
                    okButton.className = 'bg-sky-600 text-white';
                    okButton.onclick = () => overlay.remove();
                    alertBox.appendChild(okButton);
                }
                overlay.appendChild(alertBox);
                alertContainer.appendChild(overlay);
            }

            function saveMembers() {
                localStorage.setItem('gymMembers', JSON.stringify(members));
            }

            function calculateExpiryDate(startDateStr, membershipType) {
                const startDate = new Date(startDateStr + 'T00:00:00');
                if (isNaN(startDate.getTime())) {
                    console.error("Fecha de inicio inválida:", startDateStr);
                    return new Date(); 
                }
                let expiryDate = new Date(startDate);
                switch (membershipType) {
                    case 'Mensual': expiryDate.setMonth(startDate.getMonth() + 1); break;
                    case 'Trimestral': expiryDate.setMonth(startDate.getMonth() + 3); break;
                    case 'Anual': expiryDate.setFullYear(startDate.getFullYear() + 1); break;
                    default: expiryDate.setMonth(startDate.getMonth() + 1);
                }
                return expiryDate;
            }

            function getMembershipStatus(expiryDateStr) {
                const expiryDate = new Date(expiryDateStr);
                const todayDate = new Date();
                todayDate.setHours(0, 0, 0, 0); 
                expiryDate.setHours(0,0,0,0);

                const sevenDaysFromNow = new Date(todayDate);
                sevenDaysFromNow.setDate(todayDate.getDate() + 7);

                if (expiryDate < todayDate) return { text: 'Vencido', class: 'status-vencido' };
                if (expiryDate <= sevenDaysFromNow) return { text: 'Próximo a Vencer', class: 'status-proximo-vencer' };
                return { text: 'Activo', class: 'status-activo' };
            }
            
            function formatDate(date, format = 'display') {
                let d = date;
                if (!(d instanceof Date) || isNaN(d.getTime())) {
                    d = new Date(d);
                    if (isNaN(d.getTime())) return "Fecha Inválida";
                }
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return format === 'input' ? `${year}-${month}-${day}` : `${day}/${month}/${year}`;
            }

            function renderMembers(filteredMembers = members) {
                if (!membersTableBody) return;
                membersTableBody.innerHTML = ''; 

                if (filteredMembers.length === 0) {
                    noMembersMessage.classList.remove('hidden');
                    membersTable.classList.add('hidden');
                } else {
                    noMembersMessage.classList.add('hidden');
                    membersTable.classList.remove('hidden');
                }

                filteredMembers.forEach((member) => { // No necesitamos el índice aquí ya que usamos member.id
                    const expiryDate = calculateExpiryDate(member.lastPaymentDate, member.membershipType);
                    const status = getMembershipStatus(expiryDate);
                    const row = membersTableBody.insertRow();
                    row.className = `member-row ${status.class}`; 

                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">${member.fullName}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${formatDate(member.lastPaymentDate)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${member.membershipType}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${member.email}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${member.phone}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${formatDate(expiryDate)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${formatDate(expiryDate)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold">${status.text}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-1 md:space-x-2">
                            <button data-id="${member.id}" class="edit-btn text-blue-600 hover:text-blue-800 font-semibold py-1 px-2 rounded-md bg-blue-100 hover:bg-blue-200 transition">Editar</button>
                            <button data-id="${member.id}" class="renew-btn text-green-600 hover:text-green-800 font-semibold py-1 px-2 rounded-md bg-green-100 hover:bg-green-200 transition">Renovar</button>
                            <button data-id="${member.id}" class="delete-btn text-red-600 hover:text-red-800 font-semibold py-1 px-2 rounded-md bg-red-100 hover:bg-red-200 transition">Eliminar</button>
                        </td>
                    `;
                });
                addEventListenersToTableButtons();
            }
            
            function addEventListenersToTableButtons() {
                document.querySelectorAll('.edit-btn').forEach(button => button.addEventListener('click', handleOpenEditModal));
                document.querySelectorAll('.renew-btn').forEach(button => button.addEventListener('click', handleRenewMember));
                document.querySelectorAll('.delete-btn').forEach(button => button.addEventListener('click', handleDeleteMember));
            }

            if (memberForm) {
                memberForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newMember = {
                        id: Date.now().toString(), // ID único como string
                        fullName: memberForm.fullName.value,
                        lastPaymentDate: memberForm.registrationDate.value,
                        membershipType: memberForm.membershipType.value,
                        email: memberForm.email.value,
                        phone: memberForm.phone.value,
                    };
                    members.push(newMember);
                    saveMembers();
                    renderMembers(getFilteredMembers());
                    memberForm.reset();
                    if(registrationDateInput) registrationDateInput.value = today;
                    showCustomAlert('Miembro registrado exitosamente.', 'info');
                });
            }

            function handleOpenEditModal(event) {
                editingMemberId = event.target.dataset.id;
                const memberToEdit = members.find(m => m.id === editingMemberId);
                if (memberToEdit && editForm && editMemberModal) {
                    editForm.editMemberId.value = memberToEdit.id;
                    editForm.editFullName.value = memberToEdit.fullName;
                    editForm.editLastPaymentDate.value = formatDate(memberToEdit.lastPaymentDate, 'input');
                    editForm.editMembershipType.value = memberToEdit.membershipType;
                    editForm.editEmail.value = memberToEdit.email;
                    editForm.editPhone.value = memberToEdit.phone;
                    editMemberModal.classList.remove('hidden');
                } else {
                    console.error("No se pudo encontrar el miembro para editar o el formulario de edición no está disponible.");
                }
            }

            if (editForm && editMemberModal) {
                 editForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const memberIndex = members.findIndex(m => m.id === editingMemberId);
                    if (memberIndex > -1) {
                        members[memberIndex] = {
                            ...members[memberIndex], // Conserva el ID y otras propiedades no editadas
                            fullName: editForm.editFullName.value,
                            lastPaymentDate: editForm.editLastPaymentDate.value,
                            membershipType: editForm.editMembershipType.value,
                            email: editForm.editEmail.value,
                            phone: editForm.editPhone.value,
                        };
                        saveMembers();
                        renderMembers(getFilteredMembers());
                        editMemberModal.classList.add('hidden');
                        showCustomAlert('Datos del miembro actualizados.', 'info');
                        editingMemberId = null; // Resetear ID en edición
                    } else {
                         showCustomAlert('Error: No se pudo encontrar el miembro para actualizar.', 'error');
                    }
                });
            }
           

            if (cancelEditButton && editMemberModal) {
                cancelEditButton.addEventListener('click', () => {
                    editMemberModal.classList.add('hidden');
                    editingMemberId = null; // Resetear ID en edición
                });
            }


            function handleRenewMember(event) {
                const memberId = event.target.dataset.id;
                const memberIndex = members.findIndex(m => m.id === memberId);
                if (memberIndex > -1) {
                     showCustomAlert(`¿Confirmar renovación para ${members[memberIndex].fullName}? La nueva membresía comenzará hoy.`, 'confirm', () => {
                        members[memberIndex].lastPaymentDate = new Date().toISOString().split('T')[0];
                        saveMembers();
                        renderMembers(getFilteredMembers());
                        showCustomAlert('Membresía renovada.', 'info');
                    }, 'bg-green-600'); // Pasar color para botón de confirmación de renovación
                }
            }
            
            function handleDeleteMember(event) {
                const memberId = event.target.dataset.id;
                const memberIndex = members.findIndex(m => m.id === memberId);
                if (memberIndex > -1) {
                    showCustomAlert(`¿Seguro que quieres eliminar a ${members[memberIndex].fullName}?`, 'confirm', () => {
                        members.splice(memberIndex, 1);
                        saveMembers();
                        renderMembers(getFilteredMembers());
                        showCustomAlert('Miembro eliminado.', 'info');
                    });
                }
            }

            function getFilteredMembers() {
                const searchTerm = searchMemberInput ? searchMemberInput.value.toLowerCase() : '';
                if (!searchTerm) return members;
                return members.filter(member => member.fullName.toLowerCase().includes(searchTerm));
            }
            
            if (searchMemberInput) {
                searchMemberInput.addEventListener('input', () => {
                    renderMembers(getFilteredMembers());
                });
            }

            renderMembers();
        });
    </script>

</body>
</html>
